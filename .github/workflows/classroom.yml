name: Autograding Tests
'on':
  - push
  - repository_dispatch
permissions:
  checks: write
  actions: read
  contents: read

jobs:
  # JOB: –û–¶–ï–ù–ö–ê –ó–ê–î–ê–ù–ò–ô (3 –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–∫–∏)
  grade-tasks:
    name: –û—Ü–µ–Ω–∏–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–¥–∞—á
    runs-on: ubuntu-latest
    if: github.actor != 'github-classroom[bot]'
    
    strategy:
      matrix:
        task: [1, 2, 3]
      max-parallel: 3
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    
    # ============ –ó–ê–î–ê–ß–ê 1: –ö–ê–õ–¨–ö–£–õ–Ø–¢–û–† ============
    - name: "[TASK 1] –°–ª–æ–∂–µ–Ω–∏–µ"
      if: matrix.task == 1
      id: task1_add
      uses: classroom-resources/autograding-io-grader@v1
      with:
        test-name: "–ó–∞–¥–∞—á–∞ 1: –°–ª–æ–∂–µ–Ω–∏–µ"
        command: python task_01.py
        input: |
          5
          +
          3
        expected-output: '8'
        comparison-method: exact
        timeout: 5
        max-score: 10
    
    - name: "[TASK 1] –í—ã—á–∏—Ç–∞–Ω–∏–µ"
      if: matrix.task == 1
      id: task1_sub
      uses: classroom-resources/autograding-io-grader@v1
      with:
        test-name: "–ó–∞–¥–∞—á–∞ 1: –í—ã—á–∏—Ç–∞–Ω–∏–µ"
        command: python task_01.py
        input: |
          10
          -
          4
        expected-output: '6'
        comparison-method: exact
        timeout: 5
        max-score: 10
    
    - name: "[TASK 1] –î–µ–ª–µ–Ω–∏–µ –Ω–∞ –Ω–æ–ª—å"
      if: matrix.task == 1
      id: task1_div_zero
      uses: classroom-resources/autograding-io-grader@v1
      with:
        test-name: "–ó–∞–¥–∞—á–∞ 1: –î–µ–ª–µ–Ω–∏–µ –Ω–∞ –Ω–æ–ª—å"
        command: python task_01.py
        input: |
          10
          /
          0
        expected-output: 'error'
        comparison-method: contains
        timeout: 5
        max-score: 10
    
    # ============ –ó–ê–î–ê–ß–ê 2: –ü–ê–õ–ò–ù–î–†–û–ú ============
    - name: "[TASK 2] –ü—Ä–æ—Å—Ç–æ–π –ø–∞–ª–∏–Ω–¥—Ä–æ–º"
      if: matrix.task == 2
      id: task2_simple
      uses: classroom-resources/autograding-io-grader@v1
      with:
        test-name: "–ó–∞–¥–∞—á–∞ 2: –ü—Ä–æ—Å—Ç–æ–π –ø–∞–ª–∏–Ω–¥—Ä–æ–º"
        command: python task_02.py
        input: "racecar"
        expected-output: 'True'
        comparison-method: exact
        timeout: 5
        max-score: 15
    
    - name: "[TASK 2] –ù–µ –ø–∞–ª–∏–Ω–¥—Ä–æ–º"
      if: matrix.task == 2
      id: task2_not_palindrome
      uses: classroom-resources/autograding-io-grader@v1
      with:
        test-name: "–ó–∞–¥–∞—á–∞ 2: –ù–µ –ø–∞–ª–∏–Ω–¥—Ä–æ–º"
        command: python task_02.py
        input: "hello"
        expected-output: 'False'
        comparison-method: exact
        timeout: 5
        max-score: 15
    
    - name: "[TASK 2] –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞"
      if: matrix.task == 2
      id: task2_empty
      uses: classroom-resources/autograding-io-grader@v1
      with:
        test-name: "–ó–∞–¥–∞—á–∞ 2: –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞"
        command: python task_02.py
        input: ""
        expected-output: 'True'
        comparison-method: exact
        timeout: 5
        max-score: 10
    
    # ============ –ó–ê–î–ê–ß–ê 3: –§–ò–ë–û–ù–ê–ß–ß–ò ============
    - name: "[TASK 3] Fibonacci(0)"
      if: matrix.task == 3
      id: task3_fib0
      uses: classroom-resources/autograding-io-grader@v1
      with:
        test-name: "–ó–∞–¥–∞—á–∞ 3: Fibonacci(0)"
        command: python task_03.py
        input: "0"
        expected-output: '0'
        comparison-method: exact
        timeout: 5
        max-score: 10
    
    - name: "[TASK 3] Fibonacci(1)"
      if: matrix.task == 3
      id: task3_fib1
      uses: classroom-resources/autograding-io-grader@v1
      with:
        test-name: "–ó–∞–¥–∞—á–∞ 3: Fibonacci(1)"
        command: python task_03.py
        input: "1"
        expected-output: '1'
        comparison-method: exact
        timeout: 5
        max-score: 10
    
    - name: "[TASK 3] Fibonacci(10)"
      if: matrix.task == 3
      id: task3_fib10
      uses: classroom-resources/autograding-io-grader@v1
      with:
        test-name: "–ó–∞–¥–∞—á–∞ 3: Fibonacci(10)"
        command: python task_03.py
        input: "10"
        expected-output: '55'
        comparison-method: exact
        timeout: 5
        max-score: 20
    
    # ============ –ü–ê–†–°–ò–ú –†–ï–ê–õ–¨–ù–´–ï –ë–ê–õ–õ–´ ============
    - name: Parse Real Scores
      if: always()
      run: |
        if [ "${{ matrix.task }}" = "1" ]; then
          # –ü–∞—Ä—Å–∏–º –±–∞–ª–ª—ã –∏–∑ autograding —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è –∑–∞–¥–∞—á–∏ 1
          python3 tools/parse_scores.py 1 \
            "${{ steps.task1_add.outputs.result }}" \
            "${{ steps.task1_sub.outputs.result }}" \
            "${{ steps.task1_div_zero.outputs.result }}" > task_score.txt
          
        elif [ "${{ matrix.task }}" = "2" ]; then
          # –î–ª—è –∑–∞–¥–∞—á–∏ 2
          python3 tools/parse_scores.py 2 > task_score.txt
          
        elif [ "${{ matrix.task }}" = "3" ]; then
          # –î–ª—è –∑–∞–¥–∞—á–∏ 3
          python3 tools/parse_scores.py 3 > task_score.txt
        fi
        
        # echo "Task ${{ matrix.task }} score: $SCORE"
        echo "Task ${{ matrix.task }} score:"
        cat task_score.txt
    
    - name: Upload Score Artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: score-task-${{ matrix.task }}
        path: task_score.txt

  # JOB: –°–ë–û–†–ö–ê –ò–¢–û–ì–û–í–û–ô –°–í–û–î–ö–ò
  generate-final-report:
    name: –ò—Ç–æ–≥–æ–≤–∞—è —Å–≤–æ–¥–∫–∞
    runs-on: ubuntu-latest
    needs: grade-tasks
    if: always()
    
    steps:
    - name: Checkout code again
      uses: actions/checkout@v4
    
    - name: Download all score artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts
        pattern: score-task-*
        merge-multiple: true
    
    - name: Calculate Total Scores
      id: calculate
      run: |
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–∞–ª–ª—ã
        TASK1_SCORE=0
        TASK2_SCORE=0
        TASK3_SCORE=0
        
        # –ü–∞—Ä—Å–∏–º –±–∞–ª–ª—ã –∏–∑ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
        for file in $(find ./artifacts -name "task_score.txt"); do
          while IFS= read -r line || [[ -n "$line" ]]; do
            if [[ "$line" == TASK_SCORE=* ]]; then
              score="${line#TASK_SCORE=}"
              
              if [[ "$file" == *"task-1"* ]]; then
                TASK1_SCORE="$score"
              elif [[ "$file" == *"task-2"* ]]; then
                TASK2_SCORE="$score"
              elif [[ "$file" == *"task-3"* ]]; then
                TASK3_SCORE="$score"
              fi
            fi
          done < "$file"
        done
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª—ã –µ—â–µ —Ä–∞–∑ (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
        if [ -f "task_01.py" ] && [ "$TASK1_SCORE" -eq 0 ]; then
          TASK1_SCORE=10
        fi
        
        if [ -f "task_02.py" ] && [ "$TASK2_SCORE" -eq 0 ]; then
          TASK2_SCORE=10
        fi
        
        if [ -f "task_03.py" ] && [ "$TASK3_SCORE" -eq 0 ]; then
          TASK3_SCORE=10
        fi
        
        # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –±–∞–ª–ª—ã
        TASK1_MAX=30
        TASK2_MAX=40
        TASK3_MAX=40
        
        TOTAL_SCORE=$((TASK1_SCORE + TASK2_SCORE + TASK3_SCORE))
        MAX_SCORE=$((TASK1_MAX + TASK2_MAX + TASK3_MAX))
        
        echo "Final scores: Task1=$TASK1_SCORE, Task2=$TASK2_SCORE, Task3=$TASK3_SCORE"
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ outputs
        echo "task1_score=$TASK1_SCORE" >> $GITHUB_OUTPUT
        echo "task2_score=$TASK2_SCORE" >> $GITHUB_OUTPUT
        echo "task3_score=$TASK3_SCORE" >> $GITHUB_OUTPUT
        echo "total_score=$TOTAL_SCORE" >> $GITHUB_OUTPUT
        echo "max_score=$MAX_SCORE" >> $GITHUB_OUTPUT
    
    - name: Generate Final Summary
      run: |
        TASK1_SCORE=${{ steps.calculate.outputs.task1_score || 0 }}
        TASK2_SCORE=${{ steps.calculate.outputs.task2_score || 0 }}
        TASK3_SCORE=${{ steps.calculate.outputs.task3_score || 0 }}
        TOTAL_SCORE=${{ steps.calculate.outputs.total_score || 0 }}
        MAX_SCORE=${{ steps.calculate.outputs.max_score || 110 }}
        
        # –†–∞—Å—á–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç–∞
        if [ "$MAX_SCORE" -gt 0 ]; then
          PERCENTAGE=$((TOTAL_SCORE * 100 / MAX_SCORE))
        else
          PERCENTAGE=0
        fi
        
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞
        echo "## üìä –ò–¢–û–ì–û–í–´–ô –û–¢–ß–ï–¢ –ü–û –í–°–ï–ú –ó–ê–î–ê–ù–ò–Ø–ú" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### üìà –°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| –ó–∞–¥–∞–Ω–∏–µ | –ë–∞–ª–ª—ã | –ú–∞–∫—Å–∏–º—É–º | –°—Ç–∞—Ç—É—Å |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|-------|----------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| **–ó–∞–¥–∞—á–∞ 1: –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä** | $TASK1_SCORE | 30 | $(if [ $TASK1_SCORE -ge 24 ]; then echo "‚úÖ"; elif [ $TASK1_SCORE -ge 18 ]; then echo "‚ö†Ô∏è"; else echo "‚ùå"; fi) |" >> $GITHUB_STEP_SUMMARY
        echo "| **–ó–∞–¥–∞—á–∞ 2: –ü–∞–ª–∏–Ω–¥—Ä–æ–º** | $TASK2_SCORE | 40 | $(if [ $TASK2_SCORE -ge 32 ]; then echo "‚úÖ"; elif [ $TASK2_SCORE -ge 24 ]; then echo "‚ö†Ô∏è"; else echo "‚ùå"; fi) |" >> $GITHUB_STEP_SUMMARY
        echo "| **–ó–∞–¥–∞—á–∞ 3: –ß–∏—Å–ª–∞ –§–∏–±–æ–Ω–∞—á—á–∏** | $TASK3_SCORE | 40 | $(if [ $TASK3_SCORE -ge 32 ]; then echo "‚úÖ"; elif [ $TASK3_SCORE -ge 24 ]; then echo "‚ö†Ô∏è"; else echo "‚ùå"; fi) |" >> $GITHUB_STEP_SUMMARY
        echo "| **–í–°–ï–ì–û** | **$TOTAL_SCORE** | **$MAX_SCORE** | **$PERCENTAGE%** |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### üìÅ –ù–∞–π–¥–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "task_01.py" ]; then
          echo "‚úÖ **task_01.py** - –Ω–∞–π–¥–µ–Ω" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ùå **task_01.py** - –Ω–µ –Ω–∞–π–¥–µ–Ω" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -f "task_02.py" ]; then
          echo "‚úÖ **task_02.py** - –Ω–∞–π–¥–µ–Ω" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ùå **task_02.py** - –Ω–µ –Ω–∞–π–¥–µ–Ω" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -f "task_03.py" ]; then
          echo "‚úÖ **task_03.py** - –Ω–∞–π–¥–µ–Ω" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ùå **task_03.py** - –Ω–µ –Ω–∞–π–¥–µ–Ω" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### üèÜ –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞: **$TOTAL_SCORE / $MAX_SCORE**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "$TOTAL_SCORE" -eq "$MAX_SCORE" ]; then
          echo "üéâ **–ü–û–ó–î–†–ê–í–õ–Ø–ï–ú! –í—Å–µ –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –Ω–∞ 100%!**" >> $GITHUB_STEP_SUMMARY
        elif [ "$PERCENTAGE" -ge 80 ]; then
          echo "üëç **–û—Ç–ª–∏—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç! –ü–æ—á—Ç–∏ –≤—Å–µ –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã.**" >> $GITHUB_STEP_SUMMARY
        elif [ "$PERCENTAGE" -ge 60 ]; then
          echo "‚ö†Ô∏è **–•–æ—Ä–æ—à–∞—è —Ä–∞–±–æ—Ç–∞, –Ω–æ –µ—Å—Ç—å –∫—É–¥–∞ —Ä–∞—Å—Ç–∏.**" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ùå **–ù—É–∂–Ω–æ —Å–µ—Ä—å–µ–∑–Ω–æ –ø–æ—Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞–¥ –∑–∞–¥–∞–Ω–∏—è–º–∏.**" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "*–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞* ‚Ä¢ $(date)" >> $GITHUB_STEP_SUMMARY
    
    - name: Report to GitHub Classroom
      uses: classroom-resources/autograding-grading-reporter@v1
      env:
        TASK_01_RESULTS: '{"score": ${{ steps.calculate.outputs.task1_score || 0 }}, "max_score": 30}'
        TASK_02_RESULTS: '{"score": ${{ steps.calculate.outputs.task2_score || 0 }}, "max_score": 40}'
        TASK_03_RESULTS: '{"score": ${{ steps.calculate.outputs.task3_score || 0 }}, "max_score": 40}'
      with:
        runners: "task_01,task_02,task_03"

        # TASK_01_RESULTS: '{"points": ${{ steps.calculate.outputs.task1_score || 0 }}}'
        # TASK_02_RESULTS: '{"points": ${{ steps.calculate.outputs.task2_score || 0 }}}'
        # TASK_03_RESULTS: '{"points": ${{ steps.calculate.outputs.task3_score || 0 }}}'

        # runners: "task_01:${{ steps.calculate.outputs.task1_score || 0 }},task_02:${{ steps.calculate.outputs.task2_score || 0 }},task_03:${{ steps.calculate.outputs.task3_score || 0 }}"
        # runners: "task_01:${{ steps.calculate.outputs.task1_score }},task_02:${{ steps.calculate.outputs.task2_score }},task_03:${{ steps.calculate.outputs.task3_score }}"
        # –ü–æ–ø—Ä–æ–±—É–µ–º JSON —Ñ–æ—Ä–º–∞—Ç
        # runners: |
        #  [
        #    {"name": "task_01", "points": ${{ steps.calculate.outputs.task1_score || 0 }}},
        #    {"name": "task_02", "points": ${{ steps.calculate.outputs.task2_score || 0 }}},
        #    {"name": "task_03", "points": ${{ steps.calculate.outputs.task3_score || 0 }}}
        #  ]

  # JOB: –ê–ù–ê–õ–ò–ó –ö–ê–ß–ï–°–¢–í–ê –ö–û–î–ê –° –õ–ò–ù–¢–ï–†–ê–ú–ò
  code-quality-analysis:
    name: –ê–Ω–∞–ª–∏–∑ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install linters
      run: |
        echo "Installing linters..."
        pip install pylint flake8 ruff -q
        echo "Linters installed"

    - name: Run code analysis
      run: |
        echo "## üîç –î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –ö–ê–ß–ï–°–¢–í–ê –ö–û–î–ê" >> $GITHUB_STEP_SUMMARY
        echo "### –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–∏–Ω—Ç–µ—Ä—ã: PyLint, Flake8, Ruff" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º Python —Å–∫—Ä–∏–ø—Ç –∞–Ω–∞–ª–∏–∑–∞
        python3 tools/code_analysis.py >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "1. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Ruff:**" >> $GITHUB_STEP_SUMMARY
        echo '   ```bash' >> $GITHUB_STEP_SUMMARY
        echo '   ruff check --fix .' >> $GITHUB_STEP_SUMMARY
        echo '   ```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "2. **–°–ª–µ–¥—É–π—Ç–µ PEP 8:** 4 –ø—Ä–æ–±–µ–ª–∞ –¥–ª—è –æ—Ç—Å—Ç—É–ø–æ–≤, –º–∞–∫—Å–∏–º—É–º 79 —Å–∏–º–≤–æ–ª–æ–≤ –≤ —Å—Ç—Ä–æ–∫–µ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "3. **–î–æ–±–∞–≤–ª—è–π—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ —Å–ª–æ–∂–Ω—ã–º —Ñ—É–Ω–∫—Ü–∏—è–º**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "*–ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞ –≤–ª–∏—è–µ—Ç –Ω–∞ –∏—Ç–æ–≥–æ–≤—É—é –æ—Ü–µ–Ω–∫—É!*" >> $GITHUB_STEP_SUMMARY