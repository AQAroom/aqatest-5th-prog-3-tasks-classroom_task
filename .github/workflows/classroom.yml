name: Autograding Tests
on:
  - push
  - repository_dispatch
permissions:
  checks: write
  actions: read
  contents: read

jobs:
  # JOB 1: –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –∏ –∞–≥—Ä–µ–≥–∞—Ü–∏—è
  run-and-aggregate-tests:
    name: –ó–∞–ø—É—Å–∫ –∏ –∞–≥—Ä–µ–≥–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤
    runs-on: ubuntu-latest
    if: github.actor != 'github-classroom[bot]'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    
    # ============ –ó–ê–ü–£–°–ö –¢–ï–°–¢–û–í ============
    # ============ –ó–ê–î–ê–ß–ê 1: –ö–ê–õ–¨–ö–£–õ–Ø–¢–û–† ============
    - name: "[TASK 1] –°–ª–æ–∂–µ–Ω–∏–µ"
      if: matrix.task == 1
      id: task1_add
      uses: classroom-resources/autograding-io-grader@v1
      with:
        test-name: "–ó–∞–¥–∞—á–∞ 1: –°–ª–æ–∂–µ–Ω–∏–µ"
        command: python task_01.py
        input: |
          5
          +
          3
        expected-output: '8'
        comparison-method: exact
        timeout: 5
        max-score: 10
    
    - name: "[TASK 1] –í—ã—á–∏—Ç–∞–Ω–∏–µ"
      if: matrix.task == 1
      id: task1_sub
      uses: classroom-resources/autograding-io-grader@v1
      with:
        test-name: "–ó–∞–¥–∞—á–∞ 1: –í—ã—á–∏—Ç–∞–Ω–∏–µ"
        command: python task_01.py
        input: |
          10
          -
          4
        expected-output: '6'
        comparison-method: exact
        timeout: 5
        max-score: 10
    
    - name: "[TASK 1] –î–µ–ª–µ–Ω–∏–µ –Ω–∞ –Ω–æ–ª—å"
      if: matrix.task == 1
      id: task1_div_zero
      uses: classroom-resources/autograding-io-grader@v1
      with:
        test-name: "–ó–∞–¥–∞—á–∞ 1: –î–µ–ª–µ–Ω–∏–µ –Ω–∞ –Ω–æ–ª—å"
        command: python task_01.py
        input: |
          10
          /
          0
        expected-output: 'error'
        comparison-method: contains
        timeout: 5
        max-score: 10
    
    # ============ –ó–ê–î–ê–ß–ê 2: –ü–ê–õ–ò–ù–î–†–û–ú ============
    - name: "[TASK 2] –ü—Ä–æ—Å—Ç–æ–π –ø–∞–ª–∏–Ω–¥—Ä–æ–º"
      if: matrix.task == 2
      id: task2_text_en
      uses: classroom-resources/autograding-io-grader@v1
      with:
        test-name: "–ó–∞–¥–∞—á–∞ 2: –ü—Ä–æ—Å—Ç–æ–π –ø–∞–ª–∏–Ω–¥—Ä–æ–º"
        command: python task_02.py
        input: "racecar"
        expected-output: 'True'
        comparison-method: exact
        timeout: 5
        max-score: 15
    
    - name: "[TASK 2] –ù–µ –ø–∞–ª–∏–Ω–¥—Ä–æ–º"
      if: matrix.task == 2
      id: task2_not_palindrome
      uses: classroom-resources/autograding-io-grader@v1
      with:
        test-name: "–ó–∞–¥–∞—á–∞ 2: –ù–µ –ø–∞–ª–∏–Ω–¥—Ä–æ–º"
        command: python task_02.py
        input: "hello"
        expected-output: 'False'
        comparison-method: exact
        timeout: 5
        max-score: 15
    
    - name: "[TASK 2] –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞"
      if: matrix.task == 2
      id: task2_text_ru
      uses: classroom-resources/autograding-io-grader@v1
      with:
        test-name: "–ó–∞–¥–∞—á–∞ 2: –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞"
        command: python task_02.py
        input: "–∞—Ä–æ–∑–∞—É–ø–∞–ª–∞–Ω–∞–ª–∞–ø—É–∞–∑–æ—Ä–∞"
        expected-output: 'True'
        comparison-method: exact
        timeout: 5
        max-score: 10
    
    # ============ –ó–ê–î–ê–ß–ê 3: –§–ò–ë–û–ù–ê–ß–ß–ò ============
    - name: "[TASK 3] Fibonacci(0)"
      if: matrix.task == 3
      id: task3_fib0
      uses: classroom-resources/autograding-io-grader@v1
      with:
        test-name: "–ó–∞–¥–∞—á–∞ 3: Fibonacci(0)"
        command: python task_03.py
        input: "0"
        expected-output: '0'
        comparison-method: exact
        timeout: 5
        max-score: 10
    
    - name: "[TASK 3] Fibonacci(1)"
      if: matrix.task == 3
      id: task3_fib1
      uses: classroom-resources/autograding-io-grader@v1
      with:
        test-name: "–ó–∞–¥–∞—á–∞ 3: Fibonacci(1)"
        command: python task_03.py
        input: "1"
        expected-output: '1'
        comparison-method: exact
        timeout: 5
        max-score: 10
    
    - name: "[TASK 3] Fibonacci(10)"
      if: matrix.task == 3
      id: task3_fib10
      uses: classroom-resources/autograding-io-grader@v1
      with:
        test-name: "–ó–∞–¥–∞—á–∞ 3: Fibonacci(10)"
        command: python task_03.py
        input: "10"
        expected-output: '55'
        comparison-method: exact
        timeout: 5
        max-score: 20
    
    # ============ –ê–ì–†–ï–ì–ê–¶–ò–Ø –†–ï–ó–£–õ–¨–¢–ê–¢–û–í ============
   # ============ –ê–ì–†–ï–ì–ê–¶–ò–Ø –†–ï–ó–£–õ–¨–¢–ê–¢–û–í ============
    - name: Aggregate Task 1 Results
      id: aggregate_task1
      run: |
        echo "–ê–≥—Ä–µ–≥–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–¥–∞—á–∏ 1..."
        python3 tools/aggregate_results.py \
          "–ó–∞–¥–∞—á–∞ 1: –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä" \
          30 \
          "${{ steps.task1_add.outputs.result }}" \
          "${{ steps.task1_sub.outputs.result }}" \
          "${{ steps.task1_div_zero.outputs.result }}" > task1_aggregated.txt
        
        AGG_RESULT=$(grep -oP 'AGGREGATED_RESULT=\K.+' task1_aggregated.txt)
        echo "task1_aggregated=$AGG_RESULT" >> $GITHUB_OUTPUT
        
        echo "–†–µ–∑—É–ª—å—Ç–∞—Ç –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –∑–∞–¥–∞—á–∏ 1:"
        echo "$AGG_RESULT" | base64 -d | python3 -m json.tool 2>/dev/null || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å JSON"
    
    - name: Aggregate Task 2 Results
      id: aggregate_task2
      run: |
        echo "–ê–≥—Ä–µ–≥–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–¥–∞—á–∏ 2..."
        python3 tools/aggregate_results.py \
          "–ó–∞–¥–∞—á–∞ 2: –ü–∞–ª–∏–Ω–¥—Ä–æ–º" \
          40 \
          "${{ steps.task2_simple.outputs.result }}" \
          "${{ steps.task2_not_palindrome.outputs.result }}" \
          "${{ steps.task2_empty.outputs.result }}" > task2_aggregated.txt
        
        AGG_RESULT=$(grep -oP 'AGGREGATED_RESULT=\K.+' task2_aggregated.txt)
        echo "task2_aggregated=$AGG_RESULT" >> $GITHUB_OUTPUT
        
        echo "–†–µ–∑—É–ª—å—Ç–∞—Ç –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –∑–∞–¥–∞—á–∏ 2:"
        echo "$AGG_RESULT" | base64 -d | python3 -m json.tool 2>/dev/null || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å JSON"
    
    - name: Aggregate Task 3 Results
      id: aggregate_task3
      run: |
        echo "–ê–≥—Ä–µ–≥–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–¥–∞—á–∏ 3..."
        python3 tools/aggregate_results.py \
          "–ó–∞–¥–∞—á–∞ 3: –ß–∏—Å–ª–∞ –§–∏–±–æ–Ω–∞—á—á–∏" \
          40 \
          "${{ steps.task3_fib0.outputs.result }}" \
          "${{ steps.task3_fib1.outputs.result }}" \
          "${{ steps.task3_fib10.outputs.result }}" > task3_aggregated.txt
        
        AGG_RESULT=$(grep -oP 'AGGREGATED_RESULT=\K.+' task3_aggregated.txt)
        echo "task3_aggregated=$AGG_RESULT" >> $GITHUB_OUTPUT
        
        echo "–†–µ–∑—É–ª—å—Ç–∞—Ç –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –∑–∞–¥–∞—á–∏ 3:"
        echo "$AGG_RESULT" | base64 -d | python3 -m json.tool 2>/dev/null || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å JSON"
    
    # ============ –ü–†–û–í–ï–†–ö–ê –§–ê–ô–õ–û–í ============
    - name: Debug Aggregated Results
      run: |
        echo "=== –ü–†–û–í–ï–†–ö–ê –§–ê–ô–õ–û–í ==="
        
        # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π Python —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
        python3 tools/check_file_tasks.py

    # ============ –°–û–•–†–ê–ù–ï–ù–ò–ï –†–ï–ó–£–õ–¨–¢–ê–¢–û–í ============
    - name: Save Aggregated Results
      uses: actions/upload-artifact@v4
      with:
        name: aggregated-results
        path: |
          task1_aggregated.txt
          task2_aggregated.txt
          task3_aggregated.txt
        retention-days: 1
    
    # ============ –ü–ê–†–°–ò–ù–ì –ë–ê–õ–õ–û–í –î–õ–Ø –û–¢–ß–ï–¢–ê ============
    - name: Parse Scores for Report
      id: parse_scores
      run: |
        python3 tools/parse_scores.py 1 \
          "${{ steps.task1_add.outputs.result }}" \
          "${{ steps.task1_sub.outputs.result }}" \
          "${{ steps.task1_div_zero.outputs.result }}" > task1_score.txt
        
        python3 tools/parse_scores.py 2 \
          "${{ steps.task2_simple.outputs.result }}" \
          "${{ steps.task2_not_palindrome.outputs.result }}" \
          "${{ steps.task2_empty.outputs.result }}" > task2_score.txt
        
        python3 tools/parse_scores.py 3 \
          "${{ steps.task3_fib0.outputs.result }}" \
          "${{ steps.task3_fib1.outputs.result }}" \
          "${{ steps.task3_fib10.outputs.result }}" > task3_score.txt
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –±–∞–ª–ª—ã –≤ outputs
        TASK1=$(grep -oP 'TASK_SCORE=\K\d+' task1_score.txt)
        TASK2=$(grep -oP 'TASK_SCORE=\K\d+' task2_score.txt)
        TASK3=$(grep -oP 'TASK_SCORE=\K\d+' task3_score.txt)
        
        echo "task1_score=$TASK1" >> $GITHUB_OUTPUT
        echo "task2_score=$TASK2" >> $GITHUB_OUTPUT
        echo "task3_score=$TASK3" >> $GITHUB_OUTPUT
        echo "total_score=$(($TASK1 + $TASK2 + $TASK3))" >> $GITHUB_OUTPUT

  # JOB 2: –§–ò–ù–ê–õ–¨–ù–´–ô –û–¢–ß–ï–¢ –ò –û–¢–ü–†–ê–í–ö–ê –í CLASSROOM
  generate-final-report:
    name: –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞
    runs-on: ubuntu-latest
    needs: run-and-aggregate-tests
    if: always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download Aggregated Results
      uses: actions/download-artifact@v4
      with:
        name: aggregated-results
        path: ./aggregated
    
    - name: Extract Aggregated Results
      id: extract_results
      run: |
        echo "–ò–∑–≤–ª–µ–∫–∞–µ–º –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã..."
        
        # –ó–∞–¥–∞—á–∞ 1
        TASK1_AGG=$(grep -oP 'AGGREGATED_RESULT=\K.+' ./aggregated/task1_aggregated.txt 2>/dev/null || echo "")
        echo "task1_aggregated=$TASK1_AGG" >> $GITHUB_OUTPUT
        
        # –ó–∞–¥–∞—á–∞ 2
        TASK2_AGG=$(grep -oP 'AGGREGATED_RESULT=\K.+' ./aggregated/task2_aggregated.txt 2>/dev/null || echo "")
        echo "task2_aggregated=$TASK2_AGG" >> $GITHUB_OUTPUT
        
        # –ó–∞–¥–∞—á–∞ 3
        TASK3_AGG=$(grep -oP 'AGGREGATED_RESULT=\K.+' ./aggregated/task3_aggregated.txt 2>/dev/null || echo "")
        echo "task3_aggregated=$TASK3_AGG" >> $GITHUB_OUTPUT
        
        echo "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–∑–≤–ª–µ—á–µ–Ω—ã"
    
    # ============ –û–¢–ü–†–ê–í–ö–ê –í GITHUB CLASSROOM ============
    - name: Report to GitHub Classroom
      uses: classroom-resources/autograding-grading-reporter@v1
      env:
        TASK_01_RESULTS: "${{ steps.extract_results.outputs.task1_aggregated }}"
        TASK_02_RESULTS: "${{ steps.extract_results.outputs.task2_aggregated }}"
        TASK_03_RESULTS: "${{ steps.extract_results.outputs.task3_aggregated }}"
      with:
        runners: "task_01,task_02,task_03"
    
    # ============ –ì–ï–ù–ï–†–ê–¶–ò–Ø –û–¢–ß–ï–¢–ê ============
    - name: Generate Final Summary
      run: |
        TASK1_SCORE=${{ needs.run-and-aggregate-tests.outputs.task1_score || 0 }}
        TASK2_SCORE=${{ needs.run-and-aggregate-tests.outputs.task2_score || 0 }}
        TASK3_SCORE=${{ needs.run-and-aggregate-tests.outputs.task3_score || 0 }}
        TOTAL_SCORE=$((TASK1_SCORE + TASK2_SCORE + TASK3_SCORE))
        MAX_SCORE=110
        
        echo "## üìä –ò–¢–û–ì–û–í–´–ô –û–¢–ß–ï–¢ –ü–û –í–°–ï–ú –ó–ê–î–ê–ù–ò–Ø–ú" >> $GITHUB_STEP_SUMMARY
        echo "### üìà –°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞" >> $GITHUB_STEP_SUMMARY
        echo "| –ó–∞–¥–∞–Ω–∏–µ | –ë–∞–ª–ª—ã | –ú–∞–∫—Å–∏–º—É–º | –°—Ç–∞—Ç—É—Å |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|-------|----------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| **–ó–∞–¥–∞—á–∞ 1: –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä** | $TASK1_SCORE | 30 | $(if [ $TASK1_SCORE -ge 25 ]; then echo "‚úÖ"; elif [ $TASK1_SCORE -ge 15 ]; then echo "‚ö†Ô∏è"; else echo "‚ùå"; fi) |" >> $GITHUB_STEP_SUMMARY
        echo "| **–ó–∞–¥–∞—á–∞ 2: –ü–∞–ª–∏–Ω–¥—Ä–æ–º** | $TASK2_SCORE | 40 | $(if [ $TASK2_SCORE -ge 32 ]; then echo "‚úÖ"; elif [ $TASK2_SCORE -ge 20 ]; then echo "‚ö†Ô∏è"; else echo "‚ùå"; fi) |" >> $GITHUB_STEP_SUMMARY
        echo "| **–ó–∞–¥–∞—á–∞ 3: –ß–∏—Å–ª–∞ –§–∏–±–æ–Ω–∞—á—á–∏** | $TASK3_SCORE | 40 | $(if [ $TASK3_SCORE -ge 32 ]; then echo "‚úÖ"; elif [ $TASK3_SCORE -ge 20 ]; then echo "‚ö†Ô∏è"; else echo "‚ùå"; fi) |" >> $GITHUB_STEP_SUMMARY
        echo "| **–í–°–ï–ì–û** | **$TOTAL_SCORE** | **$MAX_SCORE** | **$((TOTAL_SCORE * 100 / MAX_SCORE))%** |" >> $GITHUB_STEP_SUMMARY

# JOB 3: –ê–ù–ê–õ–ò–ó –ö–ê–ß–ï–°–¢–í–ê –ö–û–î–ê –° –õ–ò–ù–¢–ï–†–ê–ú–ò  # <-- –ë–ï–ó –ü–†–û–ë–ï–õ–û–í –ü–ï–†–ï–î –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ï–ú!
  code-quality-analysis:
    name: –ê–Ω–∞–ª–∏–∑ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install linters
      run: |
        pip install pylint flake8 ruff -q

    - name: Run code analysis
      run: |
        python3 tools/code_analysis.py >> $GITHUB_STEP_SUMMARY
