name: Autograding Tests
'on':
  - push
  - repository_dispatch
permissions:
  checks: write
  actions: read
  contents: read

jobs:
  # JOB 1: Запуск тестов и агрегация
  run-and-aggregate-tests:
    name: Запуск и агрегация тестов
    runs-on: ubuntu-latest
    if: github.actor != 'github-classroom[bot]'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    
    # ============ ЗАПУСК ТЕСТОВ ============
    # [Все твои тестовые шаги остаются как есть]
    # task1_add, task1_sub, task1_div_zero, и т.д.
    
    # ============ АГРЕГАЦИЯ РЕЗУЛЬТАТОВ ============
    - name: Aggregate Task 1 Results
      id: aggregate_task1
      run: |
        echo "Агрегируем результаты задачи 1..."
        python3 tools/aggregate_results.py \
          "Задача 1: Калькулятор" \
          30 \
          "${{ steps.task1_add.outputs.result }}" \
          "${{ steps.task1_sub.outputs.result }}" \
          "${{ steps.task1_div_zero.outputs.result }}" > task1_aggregated.txt
        
        # Извлекаем результат
        AGG_RESULT=$(grep -oP 'AGGREGATED_RESULT=\K.+' task1_aggregated.txt)
        echo "task1_aggregated=$AGG_RESULT" >> $GITHUB_OUTPUT
        
        echo "Результат агрегации задачи 1:"
        echo "$AGG_RESULT" | base64 -d | python3 -m json.tool || true
    
    - name: Aggregate Task 2 Results
      id: aggregate_task2
      run: |
        echo "Агрегируем результаты задачи 2..."
        python3 tools/aggregate_results.py \
          "Задача 2: Палиндром" \
          40 \
          "${{ steps.task2_simple.outputs.result }}" \
          "${{ steps.task2_not_palindrome.outputs.result }}" \
          "${{ steps.task2_empty.outputs.result }}" > task2_aggregated.txt
        
        AGG_RESULT=$(grep -oP 'AGGREGATED_RESULT=\K.+' task2_aggregated.txt)
        echo "task2_aggregated=$AGG_RESULT" >> $GITHUB_OUTPUT
        
        echo "Результат агрегации задачи 2:"
        echo "$AGG_RESULT" | base64 -d | python3 -m json.tool || true
    
    - name: Aggregate Task 3 Results
      id: aggregate_task3
      run: |
        echo "Агрегируем результаты задачи 3..."
        python3 tools/aggregate_results.py \
          "Задача 3: Числа Фибоначчи" \
          40 \
          "${{ steps.task3_fib0.outputs.result }}" \
          "${{ steps.task3_fib1.outputs.result }}" \
          "${{ steps.task3_fib10.outputs.result }}" > task3_aggregated.txt
        
        AGG_RESULT=$(grep -oP 'AGGREGATED_RESULT=\K.+' task3_aggregated.txt)
        echo "task3_aggregated=$AGG_RESULT" >> $GITHUB_OUTPUT
        
        echo "Результат агрегации задачи 3:"
        echo "$AGG_RESULT" | base64 -d | python3 -m json.tool || true
    
    # ============ СОХРАНЕНИЕ ДЛЯ ФИНАЛЬНОГО ОТЧЕТА ============
    - name: Save Aggregated Results
      uses: actions/upload-artifact@v4
      with:
        name: aggregated-results
        path: |
          task1_aggregated.txt
          task2_aggregated.txt
          task3_aggregated.txt
        retention-days: 1

    - name: Debug Extracted Results
      run: |
        echo "=== ДЕТАЛЬНАЯ ПРОВЕРКА АГРЕГИРОВАННЫХ РЕЗУЛЬТАТОВ ==="
        
        echo ""
        echo "1. Содержимое файлов:"
        for file in ./aggregated/*.txt; do
          echo ""
          echo "Файл: $file"
          echo "Размер: $(wc -c < "$file") байт"
          cat "$file"
        done
        
        echo ""
        echo "2. Извлекаем AGGREGATED_RESULT для каждой задачи:"
        
        # Задача 1
        TASK1_RAW=$(grep -oP 'AGGREGATED_RESULT=\K.+' ./aggregated/task1_aggregated.txt 2>/dev/null || echo "NOT_FOUND")
        echo "TASK1 raw (первые 100 символов): ${TASK1_RAW:0:100}..."
        echo "Длина TASK1: ${#TASK1_RAW}"
        
        # Задача 2
        TASK2_RAW=$(grep -oP 'AGGREGATED_RESULT=\K.+' ./aggregated/task2_aggregated.txt 2>/dev/null || echo "NOT_FOUND")
        echo "TASK2 raw (первые 100 символов): ${TASK2_RAW:0:100}..."
        echo "Длина TASK2: ${#TASK2_RAW}"
        
        # Задача 3
        TASK3_RAW=$(grep -oP 'AGGREGATED_RESULT=\K.+' ./aggregated/task3_aggregated.txt 2>/dev/null || echo "NOT_FOUND")
        echo "TASK3 raw (первые 100 символов): ${TASK3_RAW:0:100}..."
        echo "Длина TASK3: ${#TASK3_RAW}"
        
        echo ""
        echo "3. Пробуем декодировать и проверить JSON:"
        
        # Функция проверки JSON
        check_json() {
          local encoded=$1
          local name=$2
          
          if [ "$encoded" = "NOT_FOUND" ] || [ -z "$encoded" ]; then
            echo "❌ $name: Нет данных"
            return
          fi
          
          echo -n "$encoded" | base64 -d 2>/dev/null | python3 -c "
    import sys, json
    try:
        data = json.load(sys.stdin)
        print(f'✅ $name: Valid JSON, score: {data.get(\"tests\", [{}])[0].get(\"score\", \"N/A\")}/{data.get(\"max_score\", \"N/A\")}')
        print(f'   Structure: {list(data.keys())}')
    except Exception as e:
        print(f'❌ $name: Invalid JSON: {e}')
    " 2>/dev/null || echo "❌ $name: Decoding failed"
        }
        
        check_json "$TASK1_RAW" "Task 1"
        check_json "$TASK2_RAW" "Task 2"
        check_json "$TASK3_RAW" "Task 3"

    # ============ ПАРСИНГ БАЛЛОВ ДЛЯ ОТЧЕТА ============
    - name: Parse Scores for Report
      id: parse_scores
      run: |
        python3 tools/parse_scores.py 1 \
          "${{ steps.task1_add.outputs.result }}" \
          "${{ steps.task1_sub.outputs.result }}" \
          "${{ steps.task1_div_zero.outputs.result }}" > task1_score.txt
        
        python3 tools/parse_scores.py 2 \
          "${{ steps.task2_simple.outputs.result }}" \
          "${{ steps.task2_not_palindrome.outputs.result }}" \
          "${{ steps.task2_empty.outputs.result }}" > task2_score.txt
        
        python3 tools/parse_scores.py 3 \
          "${{ steps.task3_fib0.outputs.result }}" \
          "${{ steps.task3_fib1.outputs.result }}" \
          "${{ steps.task3_fib10.outputs.result }}" > task3_score.txt
        
        # Сохраняем баллы в outputs
        TASK1=$(grep -oP 'TASK_SCORE=\K\d+' task1_score.txt)
        TASK2=$(grep -oP 'TASK_SCORE=\K\d+' task2_score.txt)
        TASK3=$(grep -oP 'TASK_SCORE=\K\d+' task3_score.txt)
        
        echo "task1_score=$TASK1" >> $GITHUB_OUTPUT
        echo "task2_score=$TASK2" >> $GITHUB_OUTPUT
        echo "task3_score=$TASK3" >> $GITHUB_OUTPUT
        echo "total_score=$(($TASK1 + $TASK2 + $TASK3))" >> $GITHUB_OUTPUT

  # JOB 2: ФИНАЛЬНЫЙ ОТЧЕТ И ОТПРАВКА В CLASSROOM
  generate-final-report:
    name: Итоговый отчет и отправка
    runs-on: ubuntu-latest
    needs: run-and-aggregate-tests
    if: always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download Aggregated Results
      uses: actions/download-artifact@v4
      with:
        name: aggregated-results
        path: ./aggregated
    
    - name: Extract Aggregated Results
      id: extract_results
      run: |
        echo "Извлекаем агрегированные результаты..."
        
        # Задача 1
        TASK1_AGG=$(grep -oP 'AGGREGATED_RESULT=\K.+' ./aggregated/task1_aggregated.txt 2>/dev/null || echo "")
        echo "task1_aggregated=$TASK1_AGG" >> $GITHUB_OUTPUT
        
        # Задача 2
        TASK2_AGG=$(grep -oP 'AGGREGATED_RESULT=\K.+' ./aggregated/task2_aggregated.txt 2>/dev/null || echo "")
        echo "task2_aggregated=$TASK2_AGG" >> $GITHUB_OUTPUT
        
        # Задача 3
        TASK3_AGG=$(grep -oP 'AGGREGATED_RESULT=\K.+' ./aggregated/task3_aggregated.txt 2>/dev/null || echo "")
        echo "task3_aggregated=$TASK3_AGG" >> $GITHUB_OUTPUT
        
        echo "Результаты извлечены"
    
    # ============ ОТПРАВКА В GITHUB CLASSROOM ============
    - name: Report to GitHub Classroom
      uses: classroom-resources/autograding-grading-reporter@v1
      env:
        # КЛЮЧЕВОЕ: переменные должны быть в ВЕРХНЕМ РЕГИСТРЕ
        TASK_01_RESULTS: "${{ steps.extract_results.outputs.task1_aggregated }}"
        TASK_02_RESULTS: "${{ steps.extract_results.outputs.task2_aggregated }}"
        TASK_03_RESULTS: "${{ steps.extract_results.outputs.task3_aggregated }}"
      with:
        # Runner ID должны совпадать с именами в env (без _RESULTS)
        runners: "task_01,task_02,task_03"
    
    # ============ ГЕНЕРАЦИЯ ОТЧЕТА (оставляем как есть) ============
    - name: Generate Final Summary
      run: |
        # [Твой код генерации отчета остается без изменений]
        # Используем баллы из первого job
        TASK1_SCORE=${{ needs.run-and-aggregate-tests.outputs.task1_score || 0 }}
        TASK2_SCORE=${{ needs.run-and-aggregate-tests.outputs.task2_score || 0 }}
        TASK3_SCORE=${{ needs.run-and-aggregate-tests.outputs.task3_score || 0 }}
        # ... остальной код отчета

   # JOB 3: АНАЛИЗ КАЧЕСТВА КОДА С ЛИНТЕРАМИ
  code-quality-analysis:
    name: Анализ качества кода
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install linters
      run: |
        echo "Installing linters..."
        pip install pylint flake8 ruff -q
        echo "Linters installed"

    - name: Run code analysis
      run: |
        # Только Python скрипт, без лишних echo
        python3 tools/code_analysis.py >> $GITHUB_STEP_SUMMARY

